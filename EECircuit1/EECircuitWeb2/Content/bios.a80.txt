	org	0f200h

cdisk	equ	0004h	;address of last logged disk on warm start
buff	equ	0080h	;default buffer address
buff80h	equ	0100h
cpmb	equ	0dc00h	;base of cpm console processor
bdos	equ	0e496h	;806h+cpmb basic dos (resident portion)

	jmp	boot
wboote:	jmp	wboot
	jmp	const
	jmp	conin
	jmp	conout
	jmp	list
	jmp	punch
	jmp	reader
	jmp	home
	jmp	seldsk
	jmp	settrk
	jmp	setsec
	jmp	setdma
	jmp	read
	jmp	write
	jmp	listst	;list status
	jmp	sectran

DPBASE:	DW	TRANS, 0000H
 	DW	0000H, 0000H
  	DW	DIRBF, DPBLK
 	DW	CHK00, ALL00
;	DISK PARAMETER HEADER FOR DISK 01
	DW	TRANS, 0000H
	DW	0000H, 0000H
 	DW	DIRBF, DPBLK
 	DW	CHK01, ALL01
;	DISK PARAMETER HEADER FOR DISK 02
 	DW	TRANS, 0000H
  	DW	0000H, 0000H
  	DW	DIRBF, DPBLK
  	DW	CHK02, ALL02
;	DISK PARAMETER HEADER FOR DISK 03
  	DW	TRANS, 0000H
  	DW	0000H, 0000H
  	DW	DIRBF, DPBLK
  	DW	CHK03, ALL03
;
;	SECTOR TRANSLATE VECTOR
TRANS:	DB	 1,  7, 13, 19	;SECTORS  1,  2,  3,  4
	DB	25,  5, 11, 17	;SECTORS  5,  6,  7,  6
	DB	23,  3,  9, 15	;SECTORS  9, 10, 11, 12
	DB	21,  2,  8, 14	;SECTORS 13, 14, 15, 16
	DB	20, 26,  6, 12	;SECTORS 17, 18, 19, 20
	DB	18, 24,  4, 10	;SECTORS 21, 22, 23, 24
	DB	16, 22		;SECTORS 25, 26
                  ;
DPBLK:	;DISK PARAMETER BLOCK, COMMON TO ALL DISKS
	DW	26		;SECTORS PER TRACK
	DB	3		;BLOCK SHIFT FACTOR
	DB	7		;BLOCK MASK
	DB	0		;NULL MASK
	DW	242		;DISK SIZE-1
	DW	63		;DIRECTORY MAX
	DB	192		;ALLOC 0
	DB	0		;ALLOC 1
	DW	16		;CHECK SIZE
	DW	2		;TRACK OFFSET

DIRBF:	DS	128	 	;SCRATCH DIRECTORY AREA
ALL00:	DS	31	 	;ALLOCATION VECTOR 0
ALL01:	DS	31	 	;ALLOCATION VECTOR 1
ALL02:	DS	31	 	;ALLOCATION VECTOR 2
ALL03:	DS	31	 	;ALLOCATION VECTOR 3
CHK00:	DS	16		;CHECK VECTOR 0
CHK01:	DS	16		;CHECK VECTOR 1
CHK02:	DS	16	 	;CHECK VECTOR 2
CHK03:	DS	16	 	;CHECK VECTOR 3

signon:	db	0dh,0ah,"CP/M 2.2 on EE8080",0dh,0ah,0ah,0

boot:
	lxi	sp,buff80h
	lxi	h,signon
	call	prmsg	;print message
	xra	a	;clear accumulator
	sta	cdisk	;set initially to disk a
	jmp	gocpm	;go to cp/m

	mvi	a,0
	rst	7

		;	done with the load, reset default buffer address
gocpm:	;(enter here from cold start boot)
		;	enable rst0 and rst7
	di

;	set default buffer address to 80h
	lxi	b,buff
	call	setdma

;	reset monitor entry points
	mvi	a,0c3h
	sta	0
	lxi	h,wboote
	shld	1	;jmp wboot at location 00
	sta	5
	lxi	h,bdos
	shld	6	;jmp bdos at location 5
	sta	38h	;jmp to mon80 (may have been changed by ddt)
	lxi	h,halt
	shld	39h

;	leave iobyte set
;	previously selected disk was b, send parameter to cpm
	lda	cdisk	;last logged disk number
	mov	c,a	;send to ccp to log it in
	ei
	jmp	cpmb

wboot:
	mvi	a,1
	rst	7
const:
	mvi	a,2
	rst	7
conin:
	mvi	a,3
	rst	7
conout:
	mvi	a,4
	rst	7
list:
	mvi	a,5
	rst	7
punch:
	mvi	a,6
	rst	7
reader:
	mvi	a,7
	rst	7
home:
	mvi	a,8
	rst	7
seldsk:
	mvi	a,9
	rst	7
settrk:
	mvi	a,0ah
	rst	7
setsec:
	mvi	a,0bh
	rst	7
setdma:
	mvi	a,0ch
	rst	7
read:
	mvi	a,0dh
	rst	7
write:
	mvi	a,0eh
	rst	7
listst:	;list status
	mvi	a,0fh
	rst	7
sectran:
	mvi	a,010h
	rst	7

haltmsg	db	"System halted by RTS 7",0
halt:
	lxi	h,haltmsg
	call	prmsg
	hlt

prmsg:	;print message at h,l to 0
	mov	a,m
	ora	a	;zero?
	rz
;	more to print
	push	h
	mov	c,a
	call	conout
	pop	h
	inx	h
	jmp	prmsg

conout:	;console outout c
	push	psw
	mov	a,c
	out	0f0h
	pop	psw
	ret

	end
